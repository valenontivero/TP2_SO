<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>userio.c</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">// This is a personal academic project. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++, C#, and Java: https://pvs-studio.com</a>
<a name="ln3">#include &lt;usyscalls.h&gt;</a>
<a name="ln4">#include &lt;userio.h&gt;</a>
<a name="ln5">#include &lt;stdarg.h&gt;</a>
<a name="ln6">#include &lt;colors.h&gt;</a>
<a name="ln7">#include &lt;uStrings.h&gt;</a>
<a name="ln8"> </a>
<a name="ln9">#define MAX_NUMBER_LENGTH 100</a>
<a name="ln10"> </a>
<a name="ln11">extern void fillRegs();</a>
<a name="ln12"> </a>
<a name="ln13">void print(char* string) {</a>
<a name="ln14">    sys_write(1, string, strlen(string));</a>
<a name="ln15">}</a>
<a name="ln16"> </a>
<a name="ln17">void printColor(char* string, uint64_t color) {</a>
<a name="ln18">    sys_write_color(1, string, strlen(string), color);</a>
<a name="ln19">}</a>
<a name="ln20"> </a>
<a name="ln21">void printChar(char c) {</a>
<a name="ln22">    char str[] = {c};</a>
<a name="ln23">    sys_write(1, str, 1);</a>
<a name="ln24">}</a>
<a name="ln25"> </a>
<a name="ln26">void printColorChar(char c, uint64_t color) {</a>
<a name="ln27">    char str[] = {c};</a>
<a name="ln28">    sys_write_color(1, str, 1, color);</a>
<a name="ln29">}</a>
<a name="ln30"> </a>
<a name="ln31">char getChar() {</a>
<a name="ln32">    char c[] = {0};</a>
<a name="ln33">    sys_read(0, c, 1);</a>
<a name="ln34">    return c[0];</a>
<a name="ln35">}</a>
<a name="ln36"> </a>
<a name="ln37">void putChar(char c) {</a>
<a name="ln38">    sys_write(1, &amp;c, 1);</a>
<a name="ln39">}</a>
<a name="ln40"> </a>
<a name="ln41">void printRegs() {</a>
<a name="ln42">    uint64_t regs[17];</a>
<a name="ln43">    char * regsnames[] = {&quot;RAX &quot;, &quot;RBX &quot;, &quot;RCX &quot;, &quot;RDX &quot;, &quot;RSI &quot;, &quot;RDI &quot;, &quot;RBP &quot;, &quot;RSP &quot;, &quot;R8  &quot;, &quot;R9  &quot;, &quot;R10 &quot;, &quot;R11 &quot;, &quot;R12 &quot;,</a>
<a name="ln44">        &quot;R13 &quot;, &quot;R14 &quot;, &quot;R15 &quot;, &quot;RIP &quot;};</a>
<a name="ln45">    print(&quot;\n\n&quot;);</a>
<a name="ln46">    sys_get_regs(regs);</a>
<a name="ln47">    for (int i = 0; i &lt; 17; i++) {</a>
<a name="ln48">        char hex[17];</a>
<a name="ln49">        intToHex(regs[i], hex);</a>
<a name="ln50">        printf(&quot;%s 0x%s\n&quot;, regsnames[i], hex);</a>
<a name="ln51">    }</a>
<a name="ln52">}</a>
<a name="ln53"> </a>
<a name="ln54">void printfColor(char* format, uint64_t color, ...) {</a>
<a name="ln55">    va_list args;</a>
<a name="ln56">    va_start(args, color);</a>
<a name="ln57">    int i = 0;</a>
<a name="ln58">    while (format[i] != 0) {</a>
<a name="ln59">        if (format[i] == '%') {</a>
<a name="ln60">            i++;</a>
<a name="ln61">            switch (format[i]) {</a>
<a name="ln62">                case 'd': {</a>
<a name="ln63">                    int num = va_arg(args, int);</a>
<a name="ln64">                    char str[11];</a>
<a name="ln65">                    intToStr(num, str);</a>
<a name="ln66">                    printColor(str, color);</a>
<a name="ln67">                    break;</a>
<a name="ln68">                }</a>
<a name="ln69">                case 'x': {</a>
<a name="ln70">                    int num = va_arg(args, int);</a>
<a name="ln71">                    char str[9];</a>
<a name="ln72">                    intToHex(num, str);</a>
<a name="ln73">                    printColor(str, color);</a>
<a name="ln74">                    break;</a>
<a name="ln75">                }</a>
<a name="ln76">                case 's': {</a>
<a name="ln77">                    char* str = va_arg(args, char*);</a>
<a name="ln78">                    printColor(str, color);</a>
<a name="ln79">                    break;</a>
<a name="ln80">                }</a>
<a name="ln81">                case 'c': {</a>
<a name="ln82">                    char c = va_arg(args, int);</a>
<a name="ln83">                    printColorChar(c, color);</a>
<a name="ln84">                    break;</a>
<a name="ln85">                }</a>
<a name="ln86">                default:</a>
<a name="ln87">                    printColorChar(format[i], color);</a>
<a name="ln88">                    break;</a>
<a name="ln89">            }</a>
<a name="ln90">        } else {</a>
<a name="ln91">            printColorChar(format[i], color);</a>
<a name="ln92">        }</a>
<a name="ln93">        i++;</a>
<a name="ln94">    }</a>
<a name="ln95">    va_end(args);</a>
<a name="ln96">}</a>
<a name="ln97"> </a>
<a name="ln98">void printf(char* format, ...) {</a>
<a name="ln99">    va_list args;</a>
<a name="ln100">    va_start(args, format);</a>
<a name="ln101">    int i = 0;</a>
<a name="ln102">    while (format[i] != 0) {</a>
<a name="ln103">        if (format[i] == '%') {</a>
<a name="ln104">            i++;</a>
<a name="ln105">            switch (format[i]) {</a>
<a name="ln106">                case 'd': {</a>
<a name="ln107">                    int num = va_arg(args, int);</a>
<a name="ln108">                    char str[11];</a>
<a name="ln109">                    intToStr(num, str);</a>
<a name="ln110">                    printColor(str, WHITE);</a>
<a name="ln111">                    break;</a>
<a name="ln112">                }</a>
<a name="ln113">                case 'x': {</a>
<a name="ln114">                    int num = va_arg(args, int);</a>
<a name="ln115">                    char str[9];</a>
<a name="ln116">                    intToHex(num, str);</a>
<a name="ln117">                    printColor(str, WHITE);</a>
<a name="ln118">                    break;</a>
<a name="ln119">                }</a>
<a name="ln120">                case 's': {</a>
<a name="ln121">                    char* str = va_arg(args, char*);</a>
<a name="ln122">                    printColor(str, WHITE);</a>
<a name="ln123">                    break;</a>
<a name="ln124">                }</a>
<a name="ln125">                case 'c': {</a>
<a name="ln126">                    char c = va_arg(args, int);</a>
<a name="ln127">                    printColorChar(c, WHITE);</a>
<a name="ln128">                    break;</a>
<a name="ln129">                }</a>
<a name="ln130">                default:</a>
<a name="ln131">                    printColorChar(format[i], WHITE);</a>
<a name="ln132">                    break;</a>
<a name="ln133">            }</a>
<a name="ln134">        } else {</a>
<a name="ln135">            printColorChar(format[i], WHITE);</a>
<a name="ln136">        }</a>
<a name="ln137">        i++;</a>
<a name="ln138">    }</a>
<a name="ln139">    va_end(args);</a>
<a name="ln140">}</a>
<a name="ln141"> </a>
<a name="ln142">void scanf(char * format,...) {</a>
<a name="ln143">	char buffer[1024];</a>
<a name="ln144">	if(sys_read(STDIN, buffer, 1024) == -1) {</a>
<a name="ln145">		return;</a>
<a name="ln146">	}</a>
<a name="ln147"> </a>
<a name="ln148">	if(*format != '%') {</a>
<a name="ln149">		sys_write(STDERR, &quot;wrong use for scanf\n&quot;, 20);</a>
<a name="ln150">		return;</a>
<a name="ln151">	}</a>
<a name="ln152"> </a>
<a name="ln153">	va_list vl;</a>
<a name="ln154">	va_start(vl, format);</a>
<a name="ln155">	int buffIdx = 0;</a>
<a name="ln156">	while (*format != 0) {</a>
<a name="ln157">		if(*format != '%') {</a>
<a name="ln158">			if (*format != ' ') {</a>
<a name="ln159">		        sys_write(STDERR, &quot;wrong use for scanf\n&quot;, 20);</a>
<a name="ln160">				return;</a>
<a name="ln161">			} else {</a>
<a name="ln162">				(*format)++;</a>
<a name="ln163">			}</a>
<a name="ln164">		}</a>
<a name="ln165">		else {</a>
<a name="ln166">			(*format)++;</a>
<a name="ln167">			switch (*format) {</a>
<a name="ln168">            	case 'd':</a>
<a name="ln169">				case 'D':</a>
<a name="ln170">					*(int *)va_arg( vl, int* ) = strtoi(buffer, &amp;buffIdx);	</a>
<a name="ln171">                	break;</a>
<a name="ln172">            	case 'c':</a>
<a name="ln173">				case 'C':</a>
<a name="ln174">					*(char *)va_arg( vl, char* ) = buffer[buffIdx++];</a>
<a name="ln175">                	break;</a>
<a name="ln176">				case 's':</a>
<a name="ln177">                case 'S':</a>
<a name="ln178">                    strcpy((char *)va_arg( vl, char* ), buffer + buffIdx);</a>
<a name="ln179">                    buffIdx += strlen(buffer + buffIdx) + 1;</a>
<a name="ln180">                    break;</a>
<a name="ln181">                default:</a>
<a name="ln182">                    sys_write(STDERR, &quot;wrong use for scanf\n&quot;, 20);</a>
<a name="ln183">                    return;</a>
<a name="ln184">			}</a>
<a name="ln185">			(*format)++;	</a>
<a name="ln186">		}</a>
<a name="ln187">	}</a>
<a name="ln188">	va_end(vl);</a>
<a name="ln189">}</a>
<a name="ln190"> </a>
<a name="ln191">void fillRegisters() {</a>
<a name="ln192">	printColor(&quot;\n\nFilling registers...\n&quot;, YELLOW);</a>
<a name="ln193">	printColor(&quot;Press CTRL to save them.\n&quot;, CYAN);</a>
<a name="ln194">	fillRegs();</a>
<a name="ln195">}</a>
<a name="ln196"> </a>
<a name="ln197">char * getTime() {</a>
<a name="ln198">	static char bufferTime[9];</a>
<a name="ln199">	sys_get_time(bufferTime);</a>
<a name="ln200">	return bufferTime;</a>
<a name="ln201">}</a>
<a name="ln202"> </a>
<a name="ln203">char * getDate() {</a>
<a name="ln204">	static char bufferDate[9];</a>
<a name="ln205">	sys_get_date(bufferDate);</a>
<a name="ln206">	return bufferDate;</a>
<a name="ln207">}</a>
<a name="ln208"> </a>
<a name="ln209">void unsigned_num_to_str(uint32_t num, uint32_t start, char *buff)</a>
<a name="ln210">{</a>
<a name="ln211"> </a>
<a name="ln212">    uint32_t i = start;</a>
<a name="ln213">    if (num == 0)</a>
<a name="ln214">        buff[i++] = '0';</a>
<a name="ln215">    while (i &lt; MAX_NUMBER_LENGTH - 1 &amp;&amp; num &gt; 0)</a>
<a name="ln216">    {</a>
<a name="ln217">        buff[i++] = (num % 10) + '0';</a>
<a name="ln218">        num /= 10;</a>
<a name="ln219">    }</a>
<a name="ln220">    buff[i] = 0;</a>
<a name="ln221">    uint32_t revit = start;</a>
<a name="ln222">    uint32_t revend = i - 1;</a>
<a name="ln223">    while (revit &lt; revend)</a>
<a name="ln224">    {</a>
<a name="ln225">        char aux = buff[revit];</a>
<a name="ln226">        buff[revit] = buff[revend];</a>
<a name="ln227">        buff[revend] = aux;</a>
<a name="ln228">        revit++;</a>
<a name="ln229">        revend--;</a>
<a name="ln230">    }</a>
<a name="ln231">}</a>
</code></pre>
<div class="balloon" rel="100"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v601/" target="_blank">V601</a> Pointer is implicitly cast to an integer type. Inspect the second argument.</p></div>
<div class="balloon" rel="154"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v601/" target="_blank">V601</a> Pointer is implicitly cast to an integer type. Inspect the second argument.</p></div>
<div class="balloon" rel="167"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v785/" target="_blank">V785</a> Constant expression in switch statement.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>