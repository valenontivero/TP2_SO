<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>scheduler.c</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">// This is a personal academic project. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++, C#, and Java: https://pvs-studio.com</a>
<a name="ln3">#include &lt;scheduler.h&gt;</a>
<a name="ln4">#include &lt;stdint.h&gt;</a>
<a name="ln5">#include &lt;stddef.h&gt;</a>
<a name="ln6">#include &lt;PCBQueueADT.h&gt;</a>
<a name="ln7">#include &lt;processManager.h&gt;</a>
<a name="ln8">#include &lt;mem_manager.h&gt;</a>
<a name="ln9">#include &lt;ourTime.h&gt;</a>
<a name="ln10">#include &lt;videodriver.h&gt;</a>
<a name="ln11"> </a>
<a name="ln12">static PCB* idlePCB;</a>
<a name="ln13">static int idlePID;</a>
<a name="ln14"> </a>
<a name="ln15">schedulerStruct *scheduler;</a>
<a name="ln16"> </a>
<a name="ln17">void initScheduler(void *stackBase) {</a>
<a name="ln18">  scheduler = malloc(sizeof(schedulerStruct));</a>
<a name="ln19">  if(scheduler == NULL) {</a>
<a name="ln20">    printString(&quot;Error al inicializar el scheduler: malloc fallido&quot;);</a>
<a name="ln21">    timer_wait(5000);</a>
<a name="ln22">    return;</a>
<a name="ln23">  }</a>
<a name="ln24">  for (uint8_t i = 0; i &lt; MAX_PRIO; i++) {</a>
<a name="ln25">    scheduler-&gt;schedule[i] = CreatePCBQueueADT();</a>
<a name="ln26">  }</a>
<a name="ln27"> </a>
<a name="ln28">  scheduler-&gt;currentRunningPCB = malloc(sizeof(PCB));</a>
<a name="ln29">  scheduler-&gt;currentRunningPCB-&gt;state= TERMINATED;</a>
<a name="ln30">  scheduler-&gt;currentRunningPCB-&gt;stackBase = stackBase;</a>
<a name="ln31">  for (uint8_t i = 0; i &lt; MAX_PRIO; i++) {</a>
<a name="ln32">      scheduler-&gt;count[i] = 0;</a>
<a name="ln33">  }</a>
<a name="ln34">  /* char *argv[] = { 0 };</a>
<a name="ln35">  idlePID= createProcess((void*)idleProcess,0,0,argv);</a>
<a name="ln36">  idlePCB= getPCBByPID(idlePID);  */</a>
<a name="ln37">}</a>
<a name="ln38"> </a>
<a name="ln39">void scheduleProcess(PCB *pcb) {</a>
<a name="ln40">  queueProcess(scheduler-&gt;schedule[pcb-&gt;priority], pcb);</a>
<a name="ln41">}</a>
<a name="ln42"> </a>
<a name="ln43">void descheduleProcess(PCB *pcb) {</a>
<a name="ln44">  removeProcess(scheduler-&gt;schedule[pcb-&gt;priority], pcb);</a>
<a name="ln45">}</a>
<a name="ln46"> </a>
<a name="ln47">void *schedule(void *rsp) {</a>
<a name="ln48">    if (!scheduler || !scheduler-&gt;currentRunningPCB)</a>
<a name="ln49">        return rsp;</a>
<a name="ln50"> </a>
<a name="ln51">    PCB *old = scheduler-&gt;currentRunningPCB;</a>
<a name="ln52">    old-&gt;stackPointer = rsp;</a>
<a name="ln53"> </a>
<a name="ln54">    // Guardar estado del proceso actual</a>
<a name="ln55">    if (old-&gt;state == RUNNING) {</a>
<a name="ln56">        old-&gt;state = READY;</a>
<a name="ln57">        queueProcess(scheduler-&gt;schedule[old-&gt;priority], old);</a>
<a name="ln58">    }</a>
<a name="ln59"> </a>
<a name="ln60">    PCB *next = NULL;</a>
<a name="ln61"> </a>
<a name="ln62">    // Elegir el próximo proceso según presupuesto</a>
<a name="ln63">    for (int8_t i = MAX_PRIO - 1; i &gt;= 0; i--) {</a>
<a name="ln64">        if (!isEmpty(scheduler-&gt;schedule[i]) &amp;&amp; scheduler-&gt;count[i] &lt;= (i * 5 + 1)) {</a>
<a name="ln65">            next = dequeueProcess(scheduler-&gt;schedule[i]);</a>
<a name="ln66">			/* if(next-&gt;state != READY){</a>
<a name="ln67">				queueProcess(scheduler-&gt;schedule[next-&gt;priority], next);</a>
<a name="ln68">				continue;</a>
<a name="ln69">			} */</a>
<a name="ln70">            scheduler-&gt;currentRunningPCB = next;</a>
<a name="ln71">            scheduler-&gt;currentRunningPCB-&gt;state = RUNNING;</a>
<a name="ln72">            scheduler-&gt;count[i]++;</a>
<a name="ln73">            return next-&gt;stackPointer;</a>
<a name="ln74">        }</a>
<a name="ln75">    }</a>
<a name="ln76"> </a>
<a name="ln77">    // Si nadie fue elegido, reseteo y vuelvo a intentar</a>
<a name="ln78">    for (int i = 0; i &lt; MAX_PRIO; i++)</a>
<a name="ln79">        scheduler-&gt;count[i] = 0;</a>
<a name="ln80"> </a>
<a name="ln81">    // Segunda pasada después del reset</a>
<a name="ln82">    for (int8_t i = MAX_PRIO - 1; i &gt;= 0; i--) {</a>
<a name="ln83">        if (!isEmpty(scheduler-&gt;schedule[i])) {</a>
<a name="ln84">            next = dequeueProcess(scheduler-&gt;schedule[i]);</a>
<a name="ln85">            scheduler-&gt;currentRunningPCB = next;</a>
<a name="ln86">            scheduler-&gt;currentRunningPCB-&gt;state = RUNNING;</a>
<a name="ln87">            scheduler-&gt;count[i]++;</a>
<a name="ln88">            return next-&gt;stackPointer;</a>
<a name="ln89">        }</a>
<a name="ln90">    }</a>
<a name="ln91"> </a>
<a name="ln92">    // No hay procesos listos</a>
<a name="ln93">    return rsp;</a>
<a name="ln94">}</a>
<a name="ln95"> </a>
<a name="ln96">uint16_t getCurrentPID(){return scheduler-&gt;currentRunningPCB-&gt;pid;}</a>
<a name="ln97">PCB* getCurrentProcess(){return scheduler-&gt;currentRunningPCB;}</a>
</code></pre>
<div class="balloon" rel="29"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v522/" target="_blank">V522</a> There might be dereferencing of a potential null pointer 'scheduler-&gt;currentRunningPCB'. Check lines: 29, 28.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>