<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>keyboard.c</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">// This is a personal academic project. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++, C#, and Java: https://pvs-studio.com</a>
<a name="ln3">#include &lt;string.h&gt;</a>
<a name="ln4">#include &lt;keyboard.h&gt;</a>
<a name="ln5">#include &lt;videodriver.h&gt;</a>
<a name="ln6"> </a>
<a name="ln7">#define BUFFER_SIZE 512</a>
<a name="ln8">#define MAX_KEY_PRESSED 127</a>
<a name="ln9"> </a>
<a name="ln10">static char buffer[BUFFER_SIZE] = {0};</a>
<a name="ln11">static int elemCount = 0;</a>
<a name="ln12">static int readIndex = 0;</a>
<a name="ln13">static int writeIndex = 0;</a>
<a name="ln14"> </a>
<a name="ln15">static char shiftPressed = 0;</a>
<a name="ln16">static char capsLocked = 0;</a>
<a name="ln17"> </a>
<a name="ln18">static const char charHexMap[256] = {       </a>
<a name="ln19">        0,  1/*esc*/,  '1',  '2',  '3',  '4',  '5',  '6',   '7',  '8',  '9',   '0',   '\'',  '&lt;', '\b',</a>
<a name="ln20">    '\t', 'q',  'w',  'e',  'r',  't',  'y',  'u',  'i',   'o',  'p',  '\\',   '+', '\n',   </a>
<a name="ln21">        0,     'a',  's', 'd',  'f',  'g',  'h',  'j',  'k',  'l',  ';',  '{',</a>
<a name="ln22">    '|',  5/*shift*/,  '}',  'z',  'x', 'c', 'v',  'b',  'n',  'm',  ',',  '.',  '-',    0,  </a>
<a name="ln23">    '*',     0,  ' ',    0,     0,     0/*60*/,    0,       0,         0, </a>
<a name="ln24">    0,     0,     0,    0,      0,      0,      0,      0,         17/*up*/,</a>
<a name="ln25">    0,      0,      18/*left*/,    0,     19/*right*/,     0,      0,      20/*down*/,      0,</a>
<a name="ln26">};</a>
<a name="ln27">static const char charCapsHexMap[256] = {       </a>
<a name="ln28">        0,    1,  '!',  '\&quot;',  '#',  '$',  '%',  '&amp;',   '/',  '(',  ')',   '=',   '?',  '&gt;', '\b',</a>
<a name="ln29">    '\t', 'Q',  'W',  'E',  'R',  'T',  'Y',  'U',  'I',   'O',  'P',  '^',   '*', '\n',   </a>
<a name="ln30">        0,     'A',  'S', 'D',  'F',  'G',  'H',  'J',  'K',  'L',  '~',  '[',</a>
<a name="ln31">    '/',  5/*shift*/,  ']',  'Z',  'X', 'C', 'V',  'B',  'N',  'M',  ';',  ':',  '_',    0,  </a>
<a name="ln32">    '*',     0,  ' ',    0,     0,     0/*60*/,    0,       0,         0, </a>
<a name="ln33">    0,     0,     0,    0,      0,      0,      0,      0,         17/*up*/,</a>
<a name="ln34">    0,      0,      18/*left*/,    0,     19/*right*/,     0,      0,      20/*down*/,      0,</a>
<a name="ln35">};</a>
<a name="ln36"> </a>
<a name="ln37">char isLetter(unsigned char key) {</a>
<a name="ln38">    char c = charHexMap[key];</a>
<a name="ln39">    return (c &gt;= 'a' &amp;&amp; c &lt;= 'z');</a>
<a name="ln40">}</a>
<a name="ln41"> </a>
<a name="ln42">void keyboard_handler() {</a>
<a name="ln43">    unsigned char key = getKey();</a>
<a name="ln44">    if (key &lt; 83 || key == 0xAA/* Release SHIFT */ || key == 0x3A /* CAPS Lock */) { // 83 elems in the charHexMap</a>
<a name="ln45">        if (elemCount &gt;= BUFFER_SIZE) return;  // buffer is full</a>
<a name="ln46">        </a>
<a name="ln47">        // make the array circular</a>
<a name="ln48">        if (writeIndex &gt;= BUFFER_SIZE)</a>
<a name="ln49">            writeIndex = 0;</a>
<a name="ln50"> </a>
<a name="ln51">        if (charHexMap[key] == 5 &amp;&amp; !shiftPressed) { // Shift key</a>
<a name="ln52">            shiftPressed = 1;</a>
<a name="ln53">            return;</a>
<a name="ln54">        }</a>
<a name="ln55">        if (key == 0xAA) { // Shift released</a>
<a name="ln56">            shiftPressed = 0;</a>
<a name="ln57">            return;</a>
<a name="ln58">        }</a>
<a name="ln59">        if (key == 0x3A) { // Caps Lock</a>
<a name="ln60">            capsLocked = !capsLocked;</a>
<a name="ln61">            return;</a>
<a name="ln62">        }</a>
<a name="ln63"> </a>
<a name="ln64">        buffer[writeIndex] = !isLetter(key) ? (shiftPressed ? charCapsHexMap[key] : charHexMap[key]): ((shiftPressed &amp;&amp; !capsLocked) || (!shiftPressed &amp;&amp; capsLocked)) ? charCapsHexMap[key] : charHexMap[key];</a>
<a name="ln65"> </a>
<a name="ln66">        // update iterators</a>
<a name="ln67">        elemCount++;</a>
<a name="ln68">        writeIndex++;</a>
<a name="ln69">    } else {</a>
<a name="ln70">        buffer[writeIndex] = key;</a>
<a name="ln71">        elemCount++;</a>
<a name="ln72">        writeIndex++;</a>
<a name="ln73">    }</a>
<a name="ln74">}</a>
<a name="ln75"> </a>
<a name="ln76">char getChar() {</a>
<a name="ln77">    if (elemCount == 0) { </a>
<a name="ln78">        return 0; // buffer is empty</a>
<a name="ln79">    }</a>
<a name="ln80"> </a>
<a name="ln81">    char toReturn = buffer[readIndex];</a>
<a name="ln82">    </a>
<a name="ln83">    // update iterators</a>
<a name="ln84">    elemCount--;</a>
<a name="ln85">    readIndex++;</a>
<a name="ln86"> </a>
<a name="ln87">    // make the array circular</a>
<a name="ln88">    if (readIndex == BUFFER_SIZE) readIndex = 0;</a>
<a name="ln89">    </a>
<a name="ln90">    return toReturn;</a>
<a name="ln91">}</a>
</code></pre>
<div class="balloon" rel="44"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v560/" target="_blank">V560</a> A part of conditional expression is always false: key == 0x3A.</p></div>
<div class="balloon" rel="64"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v728/" target="_blank">V728</a> An excessive check can be simplified. The '(A &amp;&amp; !B) || (!A &amp;&amp; B)' expression is equivalent to the 'bool(A) != bool(B)' expression.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>