<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>syscalls.c</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">// This is a personal academic project. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++, C#, and Java: https://pvs-studio.com</a>
<a name="ln3">#include &lt;stdint.h&gt;</a>
<a name="ln4">#include &lt;videodriver.h&gt;</a>
<a name="ln5">#include &lt;defs.h&gt;</a>
<a name="ln6">#include &lt;syscalls.h&gt;</a>
<a name="ln7">#include &lt;keyboard.h&gt;</a>
<a name="ln8">#include &lt;clock.h&gt;</a>
<a name="ln9">#include &lt;sound.h&gt;</a>
<a name="ln10">#include &lt;ourTime.h&gt;</a>
<a name="ln11">#include &lt;mySem.h&gt;</a>
<a name="ln12">#include &lt;pipe.h&gt;</a>
<a name="ln13">#include &lt;processManager.h&gt;</a>
<a name="ln14"> </a>
<a name="ln15">extern const uint64_t registers[17];</a>
<a name="ln16"> </a>
<a name="ln17"> </a>
<a name="ln18">uint64_t sys_read(uint64_t fd, uint64_t buffer, uint64_t length, uint64_t unused, uint64_t unused2, uint64_t unused3){</a>
<a name="ln19">    if (fd != STDIN) </a>
<a name="ln20">        return -1;</a>
<a name="ln21">    int i = 0;</a>
<a name="ln22">    char c;</a>
<a name="ln23">    char * buff = (char *) buffer;</a>
<a name="ln24">    while(i &lt; length &amp;&amp; (c = getChar()) != 0) {</a>
<a name="ln25">        buff[i] = c;</a>
<a name="ln26">        i++;</a>
<a name="ln27">    }</a>
<a name="ln28">    return i;</a>
<a name="ln29">}</a>
<a name="ln30"> </a>
<a name="ln31">uint64_t sys_write(uint64_t fd, uint64_t buffer, uint64_t length, uint64_t unused, uint64_t unused2, uint64_t unused3){</a>
<a name="ln32">    if (fd == STDOUT) {</a>
<a name="ln33">        printStringN((char *) buffer, length);</a>
<a name="ln34">    } else if (fd == STDERR) {</a>
<a name="ln35">        printStringNColor((char *) buffer, length, RED);</a>
<a name="ln36">    }</a>
<a name="ln37">    return 0;</a>
<a name="ln38">}</a>
<a name="ln39"> </a>
<a name="ln40">uint64_t sys_write_place(uint64_t fd, uint64_t buffer, uint64_t length, uint64_t x, uint64_t y, uint64_t unused3) {</a>
<a name="ln41">    if (fd == STDOUT) {</a>
<a name="ln42">        printStringPlace((char *) buffer, (int) x, (int) y, WHITE);</a>
<a name="ln43">    } else if (fd == STDERR) {</a>
<a name="ln44">        printStringPlace((char *) buffer, (int) x, (int) y, RED);</a>
<a name="ln45">    }</a>
<a name="ln46">    return 0;</a>
<a name="ln47">}</a>
<a name="ln48"> </a>
<a name="ln49">uint64_t sys_write_color(uint64_t fd, uint64_t buffer, uint64_t length, uint64_t color, uint64_t unused2, uint64_t unused3) {</a>
<a name="ln50">    if (fd == STDOUT || fd == STDERR) {</a>
<a name="ln51">        Color c;</a>
<a name="ln52">        c.r = (char) color;</a>
<a name="ln53">        c.g = (char) (color &gt;&gt; 8);</a>
<a name="ln54">        c.b = (char) (color &gt;&gt; 16);</a>
<a name="ln55">        printStringNColor((char *) buffer, length, c);</a>
<a name="ln56">    }</a>
<a name="ln57">    return 0;</a>
<a name="ln58">}</a>
<a name="ln59"> </a>
<a name="ln60">uint64_t sys_get_registers(uint64_t regsBuff, uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln61">    for(int i = 0; i &lt; 17; i++) {</a>
<a name="ln62">        ((uint64_t *)regsBuff)[i] = registers[i];</a>
<a name="ln63">    }</a>
<a name="ln64">    return 0; </a>
<a name="ln65">}</a>
<a name="ln66"> </a>
<a name="ln67">uint64_t sys_get_time(uint64_t buffer, uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln68">    timeToStr((char *) buffer);</a>
<a name="ln69">    return 0;</a>
<a name="ln70">}</a>
<a name="ln71"> </a>
<a name="ln72">uint64_t sys_get_date(uint64_t buffer, uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln73">    dateToStr((char *) buffer);</a>
<a name="ln74">    return 0;</a>
<a name="ln75">}</a>
<a name="ln76"> </a>
<a name="ln77">uint64_t sys_clear_screen(uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5, uint64_t unused6) {</a>
<a name="ln78">    clearScreen();</a>
<a name="ln79">    return 0;</a>
<a name="ln80">}</a>
<a name="ln81"> </a>
<a name="ln82">uint64_t sys_draw_rect(uint64_t x, uint64_t y, uint64_t width, uint64_t height, uint64_t color, uint64_t unused1) {</a>
<a name="ln83">    drawRect( (int) x, (int) y, (int) width, (int) height, (int) color );</a>
<a name="ln84">    return 0;</a>
<a name="ln85">}</a>
<a name="ln86"> </a>
<a name="ln87">uint64_t sys_play_sound(uint64_t freq, uint64_t duration, uint64_t waitAfter,uint64_t unused1, uint64_t unused2, uint64_t unused3) {</a>
<a name="ln88">    playNote((int) freq, (int) duration, (int) waitAfter);</a>
<a name="ln89">    return 0;</a>
<a name="ln90">}</a>
<a name="ln91"> </a>
<a name="ln92">uint64_t sys_get_screensize(uint64_t width, uint64_t height, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln93">    uint16_t * w = (uint16_t *) width;</a>
<a name="ln94">    uint16_t * h = (uint16_t *) height;</a>
<a name="ln95">    *w = getWidth();</a>
<a name="ln96">    *h = getHeight();</a>
<a name="ln97">    return 0;</a>
<a name="ln98">}</a>
<a name="ln99"> </a>
<a name="ln100">uint64_t sys_toggle_cursor(uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5, uint64_t unused6){</a>
<a name="ln101">    toggleCursor();</a>
<a name="ln102">    return 0;</a>
<a name="ln103">}</a>
<a name="ln104"> </a>
<a name="ln105">uint64_t sys_get_ticks(uint64_t ticks,uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln106">    uint32_t * t = (uint32_t *) ticks;    </a>
<a name="ln107">    *t = ticks_elapsed();</a>
<a name="ln108">    return 0;</a>
<a name="ln109">}</a>
<a name="ln110"> </a>
<a name="ln111">uint64_t sys_draw_image(uint64_t image, uint64_t width, uint64_t height, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln112">    drawImage((const unsigned long int *) image, (int) width, (int) height);</a>
<a name="ln113">    return 0;</a>
<a name="ln114">}</a>
<a name="ln115"> </a>
<a name="ln116">// Semaforos</a>
<a name="ln117">uint64_t sys_sem_open(uint64_t name, uint64_t initial_value, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln118">    const char *nameStr = (const char *) name;</a>
<a name="ln119">    uint8_t id = sem_open(nameStr, (uint8_t) initial_value);</a>
<a name="ln120">    if (id &gt;= MAX_SEMAPHORES) {</a>
<a name="ln121">        return (uint64_t)-1;</a>
<a name="ln122">    }</a>
<a name="ln123">    return (uint64_t) id;</a>
<a name="ln124">}</a>
<a name="ln125"> </a>
<a name="ln126">uint64_t sys_sem_wait(uint64_t id, uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln127">    int result = sem_wait((uint8_t) id);</a>
<a name="ln128">    if (result &lt; 0) {</a>
<a name="ln129">        return (uint64_t)-1;</a>
<a name="ln130">    }</a>
<a name="ln131">    return (uint64_t) 0;</a>
<a name="ln132">}</a>
<a name="ln133"> </a>
<a name="ln134">uint64_t sys_sem_post(uint64_t id, uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln135">    int result = sem_post((uint8_t) id);</a>
<a name="ln136">    if (result &lt; 0) {</a>
<a name="ln137">        return (uint64_t)-1;</a>
<a name="ln138">    }</a>
<a name="ln139">    return (uint64_t) 0;</a>
<a name="ln140">}</a>
<a name="ln141"> </a>
<a name="ln142">uint64_t sys_sem_close(uint64_t id, uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln143">    if (id &gt;= MAX_SEMAPHORES) {</a>
<a name="ln144">        return (uint64_t)-1;</a>
<a name="ln145">    }</a>
<a name="ln146">    sem_destroy((uint8_t) id);</a>
<a name="ln147">    return (uint64_t) 0;</a>
<a name="ln148">}</a>
<a name="ln149"> </a>
<a name="ln150">uint64_t sys_create_process(uint64_t entryPoint, uint64_t prio, uint64_t argc, uint64_t argv, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln151">    void (*fn)(uint8_t, char **) = (void (*)(uint8_t, char **)) entryPoint;</a>
<a name="ln152">    char ** args = (char **) argv;</a>
<a name="ln153">    pid_t pid = createProcess(fn, (int) prio, (int) argc, args, args[0]);</a>
<a name="ln154">    if (pid &lt; 0) {</a>
<a name="ln155">        return (uint64_t)-1;</a>
<a name="ln156">    }</a>
<a name="ln157">    return pid;</a>
<a name="ln158">}</a>
<a name="ln159"> </a>
<a name="ln160">uint64_t sys_pipe_open(uint64_t name, uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln161">    const char *pipeName = (const char *)name;</a>
<a name="ln162">    return (uint64_t)pipe_open(pipeName);</a>
<a name="ln163">}</a>
<a name="ln164"> </a>
<a name="ln165">uint64_t sys_pipe_read(uint64_t fd, uint64_t buffer, uint64_t length, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln166">    return pipe_read((int)fd, (char *)buffer, length);</a>
<a name="ln167">}</a>
<a name="ln168"> </a>
<a name="ln169">uint64_t sys_pipe_write(uint64_t fd, uint64_t buffer, uint64_t length, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln170">    return pipe_write((int)fd, (const char *)buffer, length);</a>
<a name="ln171">}</a>
<a name="ln172"> </a>
<a name="ln173">uint64_t sys_pipe_close(uint64_t fd, uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln174">    pipe_close((int)fd);</a>
<a name="ln175">    return 0;</a>
<a name="ln176">}</a>
<a name="ln177">uint64_t sys_wait(uint64_t pid, uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln178">    wait((pid_t) pid);</a>
<a name="ln179">    return 0;</a>
<a name="ln180">}</a>
<a name="ln181"> </a>
<a name="ln182">uint64_t sys_put_in_fg(uint64_t pid, uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln183">    putInFG((pid_t) pid);</a>
<a name="ln184">    return 0;</a>
<a name="ln185">}</a>
<a name="ln186"> </a>
<a name="ln187">uint64_t sys_timer_wait(uint64_t seconds, uint64_t unused1, uint64_t unused2, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln188">    timer_wait((int)(seconds * TICKS_FREQUENCY));</a>
<a name="ln189">    return 0;</a>
<a name="ln190">}</a>
<a name="ln191"> </a>
<a name="ln192">uint64_t sys_change_process_fd(uint64_t pid, uint64_t fd, uint64_t end, uint64_t unused3, uint64_t unused4, uint64_t unused5) {</a>
<a name="ln193">	return changeProcessFd(pid, fd, end);</a>
<a name="ln194">}</a>
</code></pre>
<div class="balloon" rel="154"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v547/" target="_blank">V547</a> Expression 'pid &lt; 0' is always false. Unsigned type value is never &lt; 0.</p></div>
<div class="balloon" rel="178"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v1031/" target="_blank">V1031</a> The 'wait' function is not declared. Passing data to or from this function can be affected.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>